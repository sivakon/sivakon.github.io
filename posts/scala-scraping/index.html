<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1" name=viewport> <meta content=#333333 name=theme-color> <base href=/ > <link href=global.css rel=stylesheet> <link href=manifest.json rel=manifest crossorigin=use-credentials> <link href=favicon.png rel=icon type=image/png> <link href=client/client-cc8f0b39.css rel=stylesheet><link href=client/client-599d02fe.css rel=stylesheet> <title>Scraping with Scala</title><style>img[alt=image]{width:600px}</style><link href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css rel=stylesheet crossorigin=anonymous integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq><link href=dracula.css rel=stylesheet> <link href=/client/client.7e23340b.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/client-cc8f0b39.css rel=preload as=style><link href=/client/client-599d02fe.css rel=preload as=style><link href=/client/[permalink].35a95ac4.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/client.11b53997.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/posts.c8616fe0.js rel=modulepreload as=script crossorigin=use-credentials><link href=/client/inject_styles.5607aec6.js rel=modulepreload as=script crossorigin=use-credentials></head> <body> <div id=sapper> <div class="svelte-uv9brr site-header-borders"><div class="svelte-uv9brr site-header"><nav class="svelte-uv9brr nav"><a class="svelte-uv9brr logo" href=/ >codex</a> <ul class="svelte-uv9brr navbar"><li class=svelte-uv9brr><a class=svelte-uv9brr href=/about>about</a></li> <li class=svelte-uv9brr><a class=svelte-uv9brr href=https://github.com/trickster/trickster.github.io/tree/dev target=_blank>github</a></ul></nav></div></div> <main class=svelte-uv9brr> <h1>Scraping with Scala</h1> <p><strong>Step 1</strong>: Download ammonite</p> <pre><code class="hljs bash language-bash"><span class=hljs-comment># Download Ammonite</span>
$ curl -L https://github.com/lihaoyi/ammonite/releases/download/2.0.4/2.12-2.0.4-boostrap > amm212 && chmod +x amm212</code></pre> <p><strong>Step 2</strong>. Start ammonite</p> <pre><code class=hljs>$ amm212 --<span class=hljs-class><span class=hljs-keyword>class</span>-<span class=hljs-title>based</span></span></code></pre> <p><strong>Step 3</strong>. We need <code>akka-streams</code></p> <pre><code class="hljs language-scala scala"><span class=hljs-keyword>import</span> $ivy.`com.typesafe.akka::akka-stream:<span class=hljs-number>2.6</span><span class=hljs-number>.3</span>`
<span class=hljs-comment>// standard imports</span>
<span class=hljs-keyword>import</span> akka.stream._
<span class=hljs-keyword>import</span> akka.stream.scaladsl._
<span class=hljs-keyword>import</span> akka.{ <span class=hljs-type>Done</span>, <span class=hljs-type>NotUsed</span> }
<span class=hljs-keyword>import</span> akka.actor.<span class=hljs-type>ActorSystem</span>
<span class=hljs-keyword>import</span> akka.util.<span class=hljs-type>ByteString</span>
<span class=hljs-keyword>import</span> scala.concurrent._
<span class=hljs-keyword>import</span> scala.concurrent.duration._

<span class=hljs-comment>// Json parsing</span>
<span class=hljs-keyword>import</span> ujson._

<span class=hljs-comment>// Handle files</span>
<span class=hljs-keyword>import</span> java.nio.file.<span class=hljs-type>Paths</span>


<span class=hljs-keyword>implicit</span> <span class=hljs-keyword>val</span> system = <span class=hljs-type>ActorSystem</span>(<span class=hljs-string>"QuickStart"</span>)

<span class=hljs-keyword>val</span> hotelids = scala.io.<span class=hljs-type>Source</span>.fromFile(<span class=hljs-string>"source.txt"</span>) <span class=hljs-comment>// we need to scrape these urls or some ids for an endpoint</span>

<span class=hljs-function><span class=hljs-keyword>def</span> <span class=hljs-title>parser</span></span>(i: <span class=hljs-type>Int</span>): (<span class=hljs-type>Int</span>, <span class=hljs-type>String</span>) = {
      <span class=hljs-keyword>val</span> url = <span class=hljs-string>s"ENDPOINT/{i}"</span>
      <span class=hljs-keyword>val</span> urlResponse = <span class=hljs-type>Try</span>(ujson.read(requests.get(url).data.toString))
      <span class=hljs-keyword>val</span> result = urlResponse <span class=hljs-keyword>match</span> {
        <span class=hljs-keyword>case</span> <span class=hljs-type>Success</span>(res) => <span class=hljs-string>"PARSED_RESULT"</span>
        <span class=hljs-keyword>case</span> <span class=hljs-type>Failure</span>(e) => <span class=hljs-string>"null"</span>
      }
      <span class=hljs-keyword>return</span> (i, result)
    }</code></pre> <p><strong>Step 4</strong>. We create file sink to store the data (you can print to console as well)</p> <pre><code class="hljs language-scala scala"><span class=hljs-function><span class=hljs-keyword>def</span> <span class=hljs-title>lineSink</span></span>(filename: <span class=hljs-type>String</span>): <span class=hljs-type>Sink</span>[(<span class=hljs-type>Int</span>, <span class=hljs-type>String</span>), <span class=hljs-type>Future</span>[<span class=hljs-type>IOResult</span>]] =
    <span class=hljs-type>Flow</span>[(<span class=hljs-type>Int</span>, <span class=hljs-type>String</span>)].map(s => <span class=hljs-type>ByteString</span>(s._1 + <span class=hljs-string>","</span> + s._2 + <span class=hljs-string>"\n"</span>)).toMat(<span class=hljs-type>FileIO</span>.toPath(<span class=hljs-type>Paths</span>.get(filename)))(<span class=hljs-type>Keep</span>.right)</code></pre> <p><strong>Step 5</strong>. Introduce throttling behavior because some websites disallow too many requests. Here, we make 25 requests in 10 seconds (5 requests in 2 seconds)</p> <pre><code class="hljs language-scala scala"><span class=hljs-keyword>val</span> resultFile = source.map(_.toInt).throttle(<span class=hljs-number>25</span>, <span class=hljs-number>10.</span>second).map(parser).runWith(lineSink(<span class=hljs-string>"output.txt"</span>))</code></pre> <h3 id=all-done-from-console-with-ammonite-shell>All done from console with Ammonite shell!!</h3></main></div> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,{post:{title:"Scraping with Scala",summary:"Using Akka Streams",date:new Date(1582934400000),filename:"scala-scraping.md",html:"\u003Cp\u003E\u003Cstrong\u003EStep 1\u003C\u002Fstrong\u003E: Download ammonite\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs bash language-bash\"\u003E\u003Cspan class=\"hljs-comment\"\u003E# Download Ammonite\u003C\u002Fspan\u003E\n$ curl -L https:\u002F\u002Fgithub.com\u002Flihaoyi\u002Fammonite\u002Freleases\u002Fdownload\u002F2.0.4\u002F2.12-2.0.4-boostrap &gt; amm212 &amp;&amp; chmod +x amm212\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Cstrong\u003EStep 2\u003C\u002Fstrong\u003E. Start ammonite\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs\"\u003E$ amm212 --\u003Cspan class=\"hljs-class\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Eclass\u003C\u002Fspan\u003E-\u003Cspan class=\"hljs-title\"\u003Ebased\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Cstrong\u003EStep 3\u003C\u002Fstrong\u003E. We need \u003Ccode\u003Eakka-streams\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs scala language-scala\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Eimport\u003C\u002Fspan\u003E $ivy.`com.typesafe.akka::akka-stream:\u003Cspan class=\"hljs-number\"\u003E2.6\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-number\"\u003E.3\u003C\u002Fspan\u003E`\n\u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F standard imports\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003Eimport\u003C\u002Fspan\u003E akka.stream._\n\u003Cspan class=\"hljs-keyword\"\u003Eimport\u003C\u002Fspan\u003E akka.stream.scaladsl._\n\u003Cspan class=\"hljs-keyword\"\u003Eimport\u003C\u002Fspan\u003E akka.{ \u003Cspan class=\"hljs-type\"\u003EDone\u003C\u002Fspan\u003E, \u003Cspan class=\"hljs-type\"\u003ENotUsed\u003C\u002Fspan\u003E }\n\u003Cspan class=\"hljs-keyword\"\u003Eimport\u003C\u002Fspan\u003E akka.actor.\u003Cspan class=\"hljs-type\"\u003EActorSystem\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003Eimport\u003C\u002Fspan\u003E akka.util.\u003Cspan class=\"hljs-type\"\u003EByteString\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003Eimport\u003C\u002Fspan\u003E scala.concurrent._\n\u003Cspan class=\"hljs-keyword\"\u003Eimport\u003C\u002Fspan\u003E scala.concurrent.duration._\n\n\u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F Json parsing\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003Eimport\u003C\u002Fspan\u003E ujson._\n\n\u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F Handle files\u003C\u002Fspan\u003E\n\u003Cspan class=\"hljs-keyword\"\u003Eimport\u003C\u002Fspan\u003E java.nio.file.\u003Cspan class=\"hljs-type\"\u003EPaths\u003C\u002Fspan\u003E\n\n\n\u003Cspan class=\"hljs-keyword\"\u003Eimplicit\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eval\u003C\u002Fspan\u003E system = \u003Cspan class=\"hljs-type\"\u003EActorSystem\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-string\"\u003E\"QuickStart\"\u003C\u002Fspan\u003E)\n\n\u003Cspan class=\"hljs-keyword\"\u003Eval\u003C\u002Fspan\u003E hotelids = scala.io.\u003Cspan class=\"hljs-type\"\u003ESource\u003C\u002Fspan\u003E.fromFile(\u003Cspan class=\"hljs-string\"\u003E\"source.txt\"\u003C\u002Fspan\u003E) \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F we need to scrape these urls or some ids for an endpoint\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Edef\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003Eparser\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E(i: \u003Cspan class=\"hljs-type\"\u003EInt\u003C\u002Fspan\u003E): (\u003Cspan class=\"hljs-type\"\u003EInt\u003C\u002Fspan\u003E, \u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E) = {\n      \u003Cspan class=\"hljs-keyword\"\u003Eval\u003C\u002Fspan\u003E url = \u003Cspan class=\"hljs-string\"\u003Es\"ENDPOINT\u002F{i}\"\u003C\u002Fspan\u003E\n      \u003Cspan class=\"hljs-keyword\"\u003Eval\u003C\u002Fspan\u003E urlResponse = \u003Cspan class=\"hljs-type\"\u003ETry\u003C\u002Fspan\u003E(ujson.read(requests.get(url).data.toString))\n      \u003Cspan class=\"hljs-keyword\"\u003Eval\u003C\u002Fspan\u003E result = urlResponse \u003Cspan class=\"hljs-keyword\"\u003Ematch\u003C\u002Fspan\u003E {\n        \u003Cspan class=\"hljs-keyword\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-type\"\u003ESuccess\u003C\u002Fspan\u003E(res) =&gt; \u003Cspan class=\"hljs-string\"\u003E\"PARSED_RESULT\"\u003C\u002Fspan\u003E\n        \u003Cspan class=\"hljs-keyword\"\u003Ecase\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-type\"\u003EFailure\u003C\u002Fspan\u003E(e) =&gt; \u003Cspan class=\"hljs-string\"\u003E\"null\"\u003C\u002Fspan\u003E\n      }\n      \u003Cspan class=\"hljs-keyword\"\u003Ereturn\u003C\u002Fspan\u003E (i, result)\n    }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Cstrong\u003EStep 4\u003C\u002Fstrong\u003E. We create file sink to store the data (you can print to console as well)\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs scala language-scala\"\u003E\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Edef\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003ElineSink\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E(filename: \u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E): \u003Cspan class=\"hljs-type\"\u003ESink\u003C\u002Fspan\u003E[(\u003Cspan class=\"hljs-type\"\u003EInt\u003C\u002Fspan\u003E, \u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E), \u003Cspan class=\"hljs-type\"\u003EFuture\u003C\u002Fspan\u003E[\u003Cspan class=\"hljs-type\"\u003EIOResult\u003C\u002Fspan\u003E]] =\n    \u003Cspan class=\"hljs-type\"\u003EFlow\u003C\u002Fspan\u003E[(\u003Cspan class=\"hljs-type\"\u003EInt\u003C\u002Fspan\u003E, \u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E)].map(s =&gt; \u003Cspan class=\"hljs-type\"\u003EByteString\u003C\u002Fspan\u003E(s._1 + \u003Cspan class=\"hljs-string\"\u003E\",\"\u003C\u002Fspan\u003E + s._2 + \u003Cspan class=\"hljs-string\"\u003E\"\\n\"\u003C\u002Fspan\u003E)).toMat(\u003Cspan class=\"hljs-type\"\u003EFileIO\u003C\u002Fspan\u003E.toPath(\u003Cspan class=\"hljs-type\"\u003EPaths\u003C\u002Fspan\u003E.get(filename)))(\u003Cspan class=\"hljs-type\"\u003EKeep\u003C\u002Fspan\u003E.right)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Cstrong\u003EStep 5\u003C\u002Fstrong\u003E. Introduce throttling behavior because some websites disallow too many requests. Here, we make 25 requests in 10 seconds (5 requests in 2 seconds)\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs scala language-scala\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Eval\u003C\u002Fspan\u003E resultFile = source.map(_.toInt).throttle(\u003Cspan class=\"hljs-number\"\u003E25\u003C\u002Fspan\u003E, \u003Cspan class=\"hljs-number\"\u003E10.\u003C\u002Fspan\u003Esecond).map(parser).runWith(lineSink(\u003Cspan class=\"hljs-string\"\u003E\"output.txt\"\u003C\u002Fspan\u003E))\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch3 id=\"all-done-from-console-with-ammonite-shell\"\u003EAll done from console with Ammonite shell!!\u003C\u002Fh3\u003E",permalink:"scala-scraping"}}]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');(function(){try{eval("async function x(){}");var main="/client/client.7e23340b.js"}catch(e){main="/client/legacy/client.1f475cec.js"};var s=document.createElement("script");try{new Function("if(0)import('')")();s.src=main;s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@2.0.4.js";s.setAttribute("data-main",main);}document.head.appendChild(s);}());</script> 